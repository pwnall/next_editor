var NextEditor={};NextEditor.create=function(d){var f=d.formElement;var c=(f)?(new NextEditor.Submitter(f)):null;var e=d.tokenizer;if(!e){e=new NextEditor.Tokenizers.WordTokenizer({})}var g=NextEditor.UI.editorClass(d.forceWater);var b=new g({inputElement:d.inputElement,formSubmitter:c,tokenizer:e});var a=new NextEditor.Input({eventSource:b.eventSource(),imeSupport:b.needsImeSupport(),observer:b,multiLine:(c?false:true)});return{ui:b,input:a,tokenizer:e}};NextEditor.UI={};NextEditor.UI.editorClass=function(a){if(a||!NextEditor.Support.hasContentEditable()){return NextEditor.UI.Water}return NextEditor.UI.Fire};NextEditor.DOM={};NextEditor.DOM.elementContent=function(b,d){var f="";var e=null;if(b.childNodes&&b.childNodes.length>0){for(var a=0;a<b.childNodes.length;a+=1){var c=this.elementContent(b.childNodes[a],d);if(c.cursor!==null){e=f.length+c.cursor}else{if(d.focusNode===b&&d.focusOffset===a){e=f.length}}f+=c.text}}else{if(d.focusNode===b){e=d.focusOffset}if(b.nodeName==="BR"){f="\n"}else{if(b.nodeName==="#text"){f=b.textContent}}}return{text:f,cursor:e}};NextEditor.DOM.buildDom=function(o,q){var b=[];var a=null;var c=null;if(q===null){q=-1}if(q===0){c=0}for(var n=0;n<o.length;n+=1){var f=o[n];var m=f[2].split("\n");var d=f[0];for(var h=0;h<m.length;h+=1){if(h>0){var l=document.createElement("br");if(q===d){c=b.length}b.push(l);d+=1}var g=m[h];var e=g.length;if(e===0){continue}var p=document.createElement("span");var k=document.createTextNode(g);p.appendChild(k);p.className=f[3];b.push(p);if(q>d&&q<d+e){a=k;c=q-d}d+=e}if(q===d){c=b.length}}return{nodes:b,cursorNode:a,cursorOffset:c}};NextEditor.Input=function(a){this.observer=a.observer;if(!this.observer){if(window.console){window.console.error("No observer given! noop")}return}var b=a.eventSource;if(!b){if(window.console){window.console.error("No eventSource given! noop")}return}this.createUnboundFunctions();if(a.imeSupport){$(b).bind("compositionstart",this,this.onIMECompositionStart);$(b).bind("compositionend",this,this.onIMECompositionEnd)}if(!a.multiLine){$(b).bind("keydown",this,this.onKeyDown)}if(NextEditor.Support.hasTextInput()){$(b).bind("textInput",this,this.onTextInput);$(b).bind("keyup",this,this.onModernKey)}else{$(b).bind("keyup",this,this.onFirefoxKey);$(b).bind("focus",this,this.onFocus);$(b).bind("blur",this,this.onBlur);this.isFocused=document.hasFocus()&&document.activeElement===b;if(this.isFocused){this.changeTick()}}};NextEditor.Input.prototype.createUnboundFunctions=function(){var a=this;this.unboundChangeTick=function(){a.changeTick()};this.unboundNotifyChange=function(){a.notifyChange()}};NextEditor.Input.prototype.delayedNotifyChange=function(){setTimeout(this.unboundNotifyChange,10)};NextEditor.Input.prototype.imeCompositionInProgress=false;NextEditor.Input.prototype.onIMECompositionStart=function(a){a.data.imeCompositionInProgress=true;return true};NextEditor.Input.prototype.onIMECompositionEnd=function(a){a.data.imeCompositionInProgress=false;a.data.delayedNotifyChange();return true};NextEditor.Input.prototype.onKeyDown=function(a){if(a.which===13){a.preventDefault();a.data.observer.onSubmitKey();return false}return true};NextEditor.Input.prototype.onTextInput=function(a){a.data.delayedNotifyChange();return true};NextEditor.Input.prototype.onFirefoxKey=function(a){a.data.imeCompositionInProgress=false;a.data.delayedNotifyChange();return true};NextEditor.Input.prototype.onModernKey=function(a){a.data.delayedNotifyChange();return true};NextEditor.Input.prototype.isFocused=false;NextEditor.Input.prototype.onFocus=function(a){a.data.isFocused=true;a.data.changeTick()};NextEditor.Input.prototype.onBlur=function(a){a.data.isFocused=false};NextEditor.Input.prototype.changeTick=function(a){this.notifyChange(a);if(this.isFocused){setTimeout(this.unboundChangeTick,20)}};NextEditor.Input.prototype.notifyChange=function(){if(this.imeCompositionInProgress){return}this.observer.onPossibleChange()};NextEditor.Submitter=function(a){this.formElement=a;if(!this.formElement){if(window.console){window.console.error("No form element given! noop")}return}};NextEditor.Submitter.prototype.formElement=null;NextEditor.Submitter.prototype.submitted=false;NextEditor.Submitter.prototype.submit=function(){if(this.submitted){return}this.submitted=true;var c=$(this.formElement),e=c.attr("method")||c.attr("data-method")||"GET",b=c.attr("action")||c.attr("href"),a=c.attr("data-type")||"script";var d=c.is("form")?c.serializeArray():[];$.ajax({url:b,data:d,dataType:a,type:e.toUpperCase()})};NextEditor.Support={};NextEditor.Support.hasTextInput=function(){var a=document.createEvent("TextEvent");return !!(a&&(a.data!==undefined))};NextEditor.Support.hasContentEditable=function(){var a=document.createElement("div");if(typeof(a.contentEditable)==="string"){var b=navigator.userAgent;if(b.indexOf("Mobile")>=0&&b.indexOf("Safari")>=0){return false}return true}else{return false}};NextEditor.Tokenizers={};NextEditor.Tokenizers.WordTokenizer=function(a){if(a.nonWordType){this.nonWordType=a.nonWordType}if(a.genericWordType){this.genericWordType=a.genericWordType}if(a.highlightedWords){this.highlightedWords=a.highlightedWords}if(a.useSegmentation){this.useSegmentation=a.useSegmentation}};NextEditor.Tokenizers.WordTokenizer.prototype.nonWordType="nonword";NextEditor.Tokenizers.WordTokenizer.prototype.genericWordType="word";NextEditor.Tokenizers.WordTokenizer.prototype.highlightedWords={};NextEditor.Tokenizers.WordTokenizer.prototype.useSegmentation=false;NextEditor.Tokenizers.WordTokenizer.prototype.wordRegexp=new RegExp("[A-Za-z]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\u4E00-\u9FFF\uF900-\uFAFF\u3400-\u4DBF]");NextEditor.Tokenizers.WordTokenizer.prototype.tokenize=function(o){var h=[];var p=null;var m=null;var k=this.wordRegexp;for(var f=0;f<o.length;f+=1){if(o[f].match(k)){if(m!==null){h.push([m,f,null,false]);m=null}if(p===null){p=f}}else{if(p!==null){h.push([p,f,null,true]);p=null}if(m===null){m=f}}}if(m!==null){h.push([m,o.length,null,false])}if(p!==null){h.push([p,o.length,null,true])}var l=[];for(f=0;f<h.length;f+=1){var c=h[f];c[1]-=c[0];if(!c[3]){c[2]=o.substr(c[0],c[1]);c[3]=this.nonWordType;l.push(c);continue}var g=(this.useSegmentation)?this.segmentToken(f,h,o):[c[1]];var a=c[0];for(var e=0;e<g.length;e+=1){var d=g[e];var b=o.substr(a,d);var n=this.highlightedWords[b]||this.genericWordType;l.push([a,d,b,n]);a+=d}}return l};NextEditor.Tokenizers.WordTokenizer.prototype.segmentToken=function(a,e,f){var d=e[a];var g=d[1];var b=new Array(g);for(var c=0;c<g;c+=1){b[c]=1}return b};NextEditor.UI.Fire=function(a){this.inputElement=a.inputElement;if(!this.inputElement){if(window.console){window.console.error("No input elment given! noop")}return}this.tokenizer=a.tokenizer;if(!this.tokenizer){if(window.console){window.console.error("No tokenizer given! noop")}return}this.formSubmitter=a.formSubmitter;this.buildEditor()};NextEditor.UI.Fire.prototype.inputElement=null;NextEditor.UI.Fire.prototype.formElement=null;NextEditor.UI.Fire.prototype.editorElement=null;NextEditor.UI.Fire.prototype.buildEditor=function(){var a=this.inputElement.className;this.inputElement.className="";this.inputElement.style.visibility="hidden";this.inputElement.style.position="absolute";this.inputElement.style.width=0;this.inputElement.style.height=0;this.inputElement.style.margin=0;this.inputElement.style.padding=0;this.inputElement.style.border="none";this.inputElement.style.left=0;this.inputElement.style.top=0;this.editorElement=document.createElement("div");this.editorElement.style.width=this.editorElement.style.height="100%";this.editorElement.style.margin="0";this.editorElement.style.padding="0";this.editorElement.style.border="none";$(this.editorElement).attr("contentEditable","true");var f=document.createElement("div");f.className=a;$(this.inputElement).before(f);$(f).append(this.editorElement);$(f).append(this.inputElement);var e=$(this.inputElement).attr("value");var c=this.tokenizer.tokenize(e+"\n");var d=(document.activeElement===this.editorElement)?e.length:null;var b=NextEditor.DOM.buildDom(c,e.length);this.setEditorContent(b)};NextEditor.UI.Fire.prototype.oldContent=null;NextEditor.UI.Fire.prototype.onPossibleChange=function(){var e=this.editorElement.innerHTML;if(this.oldContent===e){return}var a=window.getSelection();var c=NextEditor.DOM.elementContent(this.editorElement,a);if(c.text[c.text.length-1]!=="\n"){c.text+="\n"}if(c.cursor===c.length){c.cursor=c.length-1}var d=this.tokenizer.tokenize(c.text);var b=NextEditor.DOM.buildDom(d,c.cursor);if(b.cursorOffset!==null){this.setEditorContent(b);this.oldContent=this.editorElement.innerHTML;$(this.inputElement).attr("value",c.text.substr(0,c.text.length-1))}};NextEditor.UI.Fire.prototype.setEditorContent=function(e){this.editorElement.innerHTML="";for(var b=0;b<e.nodes.length;b+=1){this.editorElement.appendChild(e.nodes[b])}if(e.cursorOffset!==null){var a=document.createRange();var d=e.cursorNode||this.editorElement;a.setStart(d,e.cursorOffset);a.setEnd(d,e.cursorOffset);var c=window.getSelection();c.removeAllRanges();c.addRange(a)}};NextEditor.UI.Fire.prototype.onSubmitKey=function(){this.formSubmitter.submit()};NextEditor.UI.Fire.prototype.eventSource=function(){return this.editorElement};NextEditor.UI.Fire.prototype.needsImeSupport=function(){return true};NextEditor.UI.Water=function(a){this.inputElement=a.inputElement;if(!this.inputElement){if(window.console){window.console.error("No input elment given! noop")}return}this.tokenizer=a.tokenizer;if(!this.tokenizer){if(window.console){window.console.error("No tokenizer given! noop")}return}this.formSubmitter=a.formSubmitter;this.buildEditor()};NextEditor.UI.Water.prototype.inputElement=null;NextEditor.UI.Water.prototype.formElement=null;NextEditor.UI.Water.prototype.editorElement=null;NextEditor.UI.Water.prototype.buildEditor=function(){var a=this.inputElement.className;var b=document.createElement("div");b.className=a+" rigid_editor";$(this.inputElement).before(b);this.editorElement=document.createElement("div");this.editorElement.style.position="absolute";this.editorElement.style.width=this.editorElement.style.height="100%";this.editorElement.style.margin=0;this.editorElement.style.padding=0;this.editorElement.style.border="none";this.editorElement.style.zIndex=-5;this.editorElement.style.resize="none";this.editorElement.style.overflow="hidden";this.inputElement.className="";this.inputElement.style.position="absolute";this.inputElement.style.width=this.inputElement.style.height="100%";this.inputElement.style.margin=0;this.inputElement.style.padding=0;this.inputElement.style.border="none";this.inputElement.style.zIndex=0;this.inputElement.style.backgroundColor="transparent";this.inputElement.style.color="rgba(0, 0, 0, 0)";this.inputElement.style.font="inherit";this.inputElement.style.resize="none";this.inputElement.style.overflow="hidden";$(b).append(this.editorElement);$(b).append(this.inputElement);this.onPossibleChange()};NextEditor.UI.Water.prototype.oldContent=null;NextEditor.UI.Water.prototype.onPossibleChange=function(){var c=$(this.inputElement).attr("value");if(this.oldContent===c){return}var b=this.tokenizer.tokenize(c);var a=NextEditor.DOM.buildDom(b,null);this.setEditorContent(a);this.oldContent=c};NextEditor.UI.Water.prototype.setEditorContent=function(b){this.editorElement.innerHTML="";for(var a=0;a<b.nodes.length;a+=1){this.editorElement.appendChild(b.nodes[a])}};NextEditor.UI.Water.prototype.onSubmitKey=function(){this.formSubmitter.submit()};NextEditor.UI.Water.prototype.eventSource=function(){return this.inputElement};NextEditor.UI.Water.prototype.needsImeSupport=function(){return false};